---
title: "Demographic Methods - Practical 5 (Fertility and Reproduction)"
date: "`r Sys.Date()`"
output:
  pdf_document: null
  latex_engine: xelatex
  includes:
    in_header: preamble.tex
  keep_tex: true
  toc: true
  number_sections: true
  fig_caption: true
  geometry: letterpaper, top=0.0cm, bottom=0.0cm, left=0.0cm, right=0.0cm
  html_document:
    df_print: paged
---

## The heading of the R script
The R script begins by clearing the workspace. It utilises the ggplot2 package for plotting; please ensure the package is installed.
```{r}
rm(list = ls())
#install.packages("ggplot2")
library(ggplot2)
```

## Reading the data
In this exercise, we are provided with age-specific estimates of the mid-year U.S. female population from 1933 to 2023, denoted as $_nW_x$; age-specific estimates of the mid-year U.S. population for both sexes, $_nN_x$; the number of person-years lived within each age interval for the female population, $_nL_x$, assuming a radix of 100,000 individuals; and the annual number of births by age of the mother, $B$. 
The data for this exercise have been compiled from two public repositories: the *Human Mortality Database* (HMD) and the *Human Fertility Database* (HFD). For ease of access, an excerpt has been temporarily stored in a GitHub repository and can be retrieved using the following lines of code. However, the data can also be downloaded directly from the repositories (including those for other countries) by running the R script "practical_5_data.R", and providing your username and password.
```{r}
GitHub               = "https://raw.githubusercontent.com/Romero-Prieto/teaching/main/Demographic%20Methods/practical_5.csv"
data                 = read.csv(GitHub)
print(data[1:20, ])
```

## Data preparation
Fertility and reproduction calculations focus on the year 2001, though any year between 1933 and 2023 may be selected. The following lines show how to filter the dataset for the year 2001 with the function "subset()" and how to generate key variables by selecting specific columns and rows. The function "rm()" is used to eliminate unnecessary information.
```{r}
year                 = 2001
radix                = 100000
data                 = subset(data, "Year" == year)
x                    = data[, "x"]
nWx                  = data[, "nWx"]
nNx_t                = data[, "nNx_total"]
nLx                  = data[, "nLx"]
B                    = data[, "B"]
rm(data)
```
As is standard in life table calculations, the length of age intervals can be defined based on the values of $x$, while auxiliary variables—such as the open-ended age interval and reproductive age ranges—can be identified using logical operators.
```{r}
n                    = c(diff(x,1),NA)
sEL                  = !is.na(n)
rEP                  = x >= 15 & x < 50
```
## Examples
Data could be used to calculate the life expectancy at birth $e_0$, using all values of $_nL_x$ and the radix.  
$e_0 = \frac{\sum_{a=0}^{\infty}{_nL_a}}{l_0}$
```{r}
sum(nLx)/radix
```
The same mortality data could be used to calculate the number of years a newborn is expecting lo live while in the reproductive ages, i.e., between 15 and 50, dividing the total number of person-years years lived between 15 and 50 by the radix.  
$\frac{T_{15} - T_{50}}{l_0} = \frac{\sum_{a=15}^{\infty}{_nL_a} - \sum_{a=50}^{\infty}{_nL_a}}{l_0}$
```{r}
(sum(nLx[x >= 15]) - sum(nLx[x >= 50]))/radix
```
alternatively,  
$\frac{\sum_{a=15}^{50 - n}{_nL_a}}{l_0}$
```{r}
sum(nLx[x >= 15 & x < 50])/radix
```
which is the same as:  
```{r}
sum(nLx[rEP])/radix
```

# Exercise 1: Fertility and reproduction question (Compulsory)
## Calculate the following values and comment on your results.
**a. Crude Birth Rate.**  
```{r}
sum(B)/sum(nNx_t)*1000
```
**b. Child-Woman Ratio.**
Hint: use the variable "rEP" to identify observations related to reproductive ages.
```{r}
sum(nNx_t[x < 5])/sum(nWx[rEP])
```
**c. General Fertility Rate.**  
```{r}
sum(B)/sum(nWx[rEP])*1000
```
**d. Age specific fertility rates $_nf_x$.**  
```{r}
nFx                  = B/nWx
```
**e. Total Fertility Rate.**  
```{r}
TFR                  = sum(n[rEP]*nFx[rEP])
TFR
```
**f. Gross Reproduction Rate.**  
Hint: assume a Sex Ratio at Birth equal to 1.05 males per female. 
```{r}
SRB                  = 1.05
GRR                  = 1/(1 + SRB)*TFR
GRR
```
**g. Net Reproduction Rate.**  
```{r}
NRR                  = 1/(1 + SRB)*sum(nFx[rEP]*nLx[rEP]/radix)
NRR
```
**h. Calculate the Mean Age of the Fertility Schedule $\mu_f$.**  
```{r}
age                  = x + n/2
sum(n[rEP]*nFx[rEP]*age[rEP])/TFR
```
**i. Calculate the probability to survive to the Mean Age of the Fertility Schedule $p(\mu_f)$.**  
```{r}
NRR/GRR
```

# Exercise 2: Fertility and reproduction question (Compulsory)
## Plot the Fertility Schedule (i.e., $_nf_x$ as a function of $x$).
Hint: Rates are plotted at the midpoint of the age interval.
```{r}
coloUR               = c("A"     = rgb(0.00,0.55,0.65,0.35), 
                         "B"     = rgb(0.45,0.65,0.20,0.65))
fertility            = data.frame(age, nFx)
fertility            = fertility[sEL, ]
ggplot(fertility, aes(x = age, y = nFx)) + 
  geom_polygon(fill = coloUR["A"], color = coloUR["B"]) +
  coord_cartesian(xlim = c(10, 50)) +
  scale_x_continuous(breaks = seq(10, 50, by = 5)) +
  ggtitle(paste("Age-specific fertility rates, U.S. population of",year))
```

# Exercise 3: Fertility and reproduction question (Optional)
## Estimate the TFR and NRR for all available years, and address the following questions.
In which year after World War II did fertility first fall below replacement level? Between 1933 and 1941, the Total Fertility Rate exceeded two children per woman, yet the net reproduction rate remained below replacement. What accounts for this discrepancy?  
Hint: Use a loop to consolidate the $_nL_x$ and $_nF_x$ matrices. Estimate all years simultaneously using a single line of code.
```{r}
rm(year, B, nWx, nFx, nLx, nNx_t, age, coloUR)
data                 = read.csv(GitHub)
data[,"nFx"]         = data[, "B"]/data[, "nWx"]
data                 = data[, c("Year", "x", "nLx", "nFx")]
Year                 = min(data[, "Year"]):max(data[, "Year"])
nFx                  = matrix(NA, nrow = length(x), ncol = length(Year))
nLx                  = nFx

for (i in 1:length(Year)) {
  temp     = data[data[, "Year"] == Year[i],]
  nFx[, i] = temp[, "nFx"]
  nLx[, i] = temp[, "nLx"]
}

TFR                  = colSums(n[rEP]*nFx[rEP, ]) 
NRR                  = 1/(1 + SRB)*colSums(nLx[rEP, ]*nFx[rEP, ])/radix 
data.frame(Year,TFR,NRR)
```
